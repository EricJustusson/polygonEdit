<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
</head>
<body>
  <img src="css/polyUp.png" id="polyClick" />
  <div id="map" style="width:500px; height:500px; float:left; margin:5px;"></div>
  <div id="info"></div>
</body>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/prototype/1.7.0.0/prototype.js"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?libraries=geometry&sensor=false"></script>
<script type="text/javascript" src="polygonEdit.js"></script>
<script type="text/javascript">
  var map;
  var mapPolygon;
  var addPolygon;
  function initializeMap() {
    map = new google.maps.Map(document.getElementById("map"),{zoom: 14,
                                                                  center: new google.maps.LatLng(50.909528, 34.811726),
                                                                  mapTypeId: google.maps.MapTypeId.ROADMAP,
                                                                  draggingCursor: 'crosshair'
                                                                 });
    mapPolygon = new google.maps.Polygon({map : map,
                                        strokeColor   : '#ff0000',
                                        strokeOpacity : 0.5,
                                        strokeWeight  : 2,
                                        path:[
                                          new google.maps.LatLng(50.91607609098315,34.80485954492187),
                                          new google.maps.LatLng(50.91753710953153,34.80485954492187),
                                          new google.maps.LatLng(50.91759122044873,34.815159227539056),
                                          new google.maps.LatLng(50.9159678655622,34.815159227539056),
                                          new google.maps.LatLng(50.91044803534999,34.81258430688476),
                                          new google.maps.LatLng(50.91044803534999,34.81584587304687),
                                          new google.maps.LatLng(50.90931151845126,34.81533088891601),
                                          new google.maps.LatLng(50.90931151845126,34.811897661376946),
                                          new google.maps.LatLng(50.90395327929007,34.8094944020996),
                                          new google.maps.LatLng(50.9040074060014,34.80700531213378),
                                          new google.maps.LatLng(50.90914915662899,34.809666063476556),
                                          new google.maps.LatLng(50.90920327729935,34.8065761586914),
                                          new google.maps.LatLng(50.91033979684091,34.80700531213378),
                                          new google.maps.LatLng(50.910285677492006,34.81035270898437),
                                          new google.maps.LatLng(50.91607609098315,34.81301346032714)
                                        ]
                                       });
    mapPolygon.runEdit(true);
    google.maps.event.addListener(mapPolygon, 'click', function() {
      document.getElementById("info").innerHTML = 'path:[';
      mapPolygon.getPath().forEach(function (vertex, inex) {
        document.getElementById("info").innerHTML += 'new google.maps.LatLng('+vertex.lat()+','+vertex.lng()+')' + ((inex<mapPolygon.getPath().getLength()-1)?',':'');
      });
      document.getElementById("info").innerHTML += ']';
    });
  }

  function clickPolygon() {
	markers = [];
    addPolygon = new google.maps.Polygon({map : map,
                                        strokeColor   : '#fff000',
                                        strokeOpacity : 0.5,
                                        strokeWeight  : 2,
                                        path          : markers
                                      });
    addPolygon.runEdit(false);
    google.maps.event.addListener(map, "click", addPolygonMarker);
    //map.setCursor('http://maps.gstatic.com/intl/en_us/mapfiles/ms/crosshairs.cur');
  }

  function addPolygonMarker(event) {
    console.log('adding');
    newMarker = createNewMarker(event);
	//demitry
	addPolygon.runEdit(true);	
	//demitry
	if (addPolygon.getPath().length == 1) {
      google.maps.event.addListener(newMarker.marker, "mouseup", closePolygon);
		//console.log(addPolygon.getPath())
    	console.log('adding if length == 1');
		addPolygon.stopEdit();
	}
    //if (addPolygon.getPath().length > 1 && addPolygon.getPath().getAt(0) == addPolygon.getPath().getAt(addPolygon.getPath().length - 1)) {
	//else {
	//	addPolygon.createGhostMarkerVertex(newMarker);
	//}
  }

  function closePolygon(event) {
    console.log('in close');
    newMarker = createNewMarker(event);
    //if (addPolygon.getPath().length > 2) {
    if (addPolygon.closed()) {
      console.log('closing');
      addPolygon.getPath().forEach(function (vertex, inex) {
        if (inex < (addPolygon.getPath().length - 1)) {
          addPolygon.createGhostMarkerVertex(vertex);
        }
      });
      google.maps.event.clearListeners(map, "click");
      google.maps.event.clearListeners(addPolygon.getPath().getAt(0).marker, "mouseup");
    }
  }

  function createNewMarker(event) {
    addPolygon.getPath().push(event.latLng);
    var newMarker = addPolygon.createMarkerVertex(event.latLng);
    newMarker.marker.inex = addPolygon.getPath().length;
    return newMarker;
  }

  document.observe("dom:loaded", function() {
    initializeMap();
    $('polyClick').observe('click', function(event) {
      clickPolygon();
    });
  });
</script>
</html>
